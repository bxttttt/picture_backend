# 智能客服功能测试说明

## 一、JUnit 测试（推荐在 IDE 中运行）

项目中有两个与智能客服相关的测试类，在 **IDE 中运行**（当前 `mvn test` 可能因 Lombok 等编译问题失败，IDE 一般可正常编译并运行）：

| 测试类 | 路径 | 说明 |
|--------|------|------|
| **ChatControllerTest** | `src/test/java/.../controller/ChatControllerTest.java` | 接口层：Mock `AgentChatService`，测试 `POST /chat` 返回格式、sessionId 传递、空消息返回 40000 |
| **AgentChatServiceImplTest** | `src/test/java/.../service/AgentChatServiceImplTest.java` | 服务层：Mock `DashScopeClient` 等，测试空消息抛异常、直接回复无 tool_calls、带 sessionId 时读写 Redis |

### 在 IntelliJ IDEA 中运行

1. 打开 `ChatControllerTest` 或 `AgentChatServiceImplTest`
2. 点击类名或方法左侧的绿色运行按钮，选择 “Run 'ChatControllerTest'" 或 “Run 'AgentChatServiceImplTest'”
3. 或右键测试类 → Run

### 测试用例简要说明

- **ChatControllerTest**
  - `chat_returnsReply`：单轮对话，校验 `data.reply`、`data.pictureIds` 为空
  - `chat_withSessionId_callsServiceWithSessionId`：带 sessionId，校验返回含 `pictureIds` 数组
  - `chat_emptyMessage_returnsErrorInBody`：空消息，校验 `code == 40000`

- **AgentChatServiceImplTest**
  - `chat_blankMessage_throwsBusinessException`：空/空白消息抛 `BusinessException`，且不调用 DashScope
  - `chat_directReplyWithoutToolCalls_returnsReply`：模型直接文本回复（无工具调用），校验 `reply` 内容
  - `chat_withSessionId_loadsAndSavesSession`：带 sessionId 时调用 Redis get/set

---

## 二、接口手工测试（curl 脚本）

应用 **启动后**，可用脚本快速打 `/chat` 接口：

```bash
# 默认请求 http://localhost:8080
./scripts/test-chat-api.sh

# 指定 baseUrl（例如端口 8081）
./scripts/test-chat-api.sh http://localhost:8081
```

脚本会依次请求：

1. 单轮：`{"message":"你好"}`
2. 多轮：`{"message":"找一些风景图","sessionId":"test-session-001"}`
3. 排行榜：`{"message":"上传排行榜前5名是谁"}`
4. 空消息：`{"message":""}`（期望返回 `code=40000`）

依赖 `jq` 美化输出；未安装可去掉脚本中的 `| jq .`。

---

## 三、单次 curl 示例

```bash
# 单轮
curl -X POST http://localhost:8080/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"你好"}'

# 多轮（同一 sessionId）
curl -X POST http://localhost:8080/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"找风景图","sessionId":"my-session-1"}'
```

正常响应示例：`{"code":0,"data":{"reply":"...","pictureIds":null},"message":"ok"}`；若触发搜图，`pictureIds` 为图片 ID 数组。

---

## 四、前置条件

- 应用已启动（如 `PictureBackendApplication`）
- 配置好 `aliyun.ai.apiKey`（DashScope），否则对话会报错
- Redis 可用（多轮会话与排行榜依赖 Redis）
